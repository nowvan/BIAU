
øð/*jshint esversion: 6 */

var express = require('express');
const fs = require('fs');
var router = express.Router();
const IPFS = require('ipfs');
const os = require('os');
var chai = require('chai');
var expect = chai.expect;
var assert = chai.assert;


/* GET home page. */
router.get('/', function(req, res, next) {


	console.log('start');
	const repoPath = 'ipfs-' + Math.random();
	
	// Create an IPFS node
	const node = new IPFS({
	  init: false,
	  start: false,
	  repo: repoPath
	});
	//
	const fileToAdd = {
	  path: 'fuckvan.txt' ,
	  content: fs.createReadStream('../public/fuckvan.txt')
	};
	
	function handleInit (err) {
	  if (err) {
	    throw err;
	  }
	
	  node.start(() => {
	    console.log('Online status: ', node.isOnline() ? 'online' : 'offline');
	
	    //document.getElementById("status").innerHTML= 'Node status: ' + (node.isOnline() ? 'online' : 'offline');
	
	    // You can write more code here to use it. Use methods like 
	    // node.files.add, node.files.get. See the API docs here:
	    // https://github.com/ipfs/interface-ipfs-core/tree/master/API
	
	    
	
	    node.files.add(fileToAdd, function (err, res) {
	      if (err || !res) {
	        return console.error('Error - ipfs files add', err, res);
	      }
	
	      res.forEach(function (file) {
	        console.log('successfully stored', file , file.hash);
	        
	
	        const hash1 = file.hash;
	        node.files.cat(hash1, function (err, stream) {
	          var res = '';
	
	          stream.on('data', function (chunk) {
	            res += chunk.toString();
	          });
	
	          stream.on('error', function (err) {
	            console.error('Error - ipfs files cat ', err);
	          });
	
	          stream.on('end', function () {
	            console.log('Got:', res);
	            //res.render('index', { got: res });
	            
	          });
	        });
	        
	       /* const hash = hash1;
	            node.files.get(hash, (err, stream) => {
	              expect(err).to.not.exist();

	              let files = [];
	              stream.pipe(through.obj((file, enc, next) => {
	                file.content.pipe(concat((content) => {
	                  files.push({
	                    path: file.path,
	                    content: content
	                  });
	                  next();
	                }));
	              }, () => {
	                expect(files).to.be.length(1);
	                expect(files[0].path).to.be.eql(hash);
	                expect(files[0].content.toString()).to.contain('Plz add me!');
	                done();
	              }));
	            });
	        */
	        
	      });
	
	
	    });
	    
	  });
	}
	
	//Init the node
	node.init(handleInit);
	res.render('index', { title: 'Express' });
});

module.exports = router;
ð